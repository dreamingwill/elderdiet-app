# 极光推送功能配置指南

## ⚠️ 重要提醒：关于 React Native + Expo 的推送架构

你的项目使用的是**混合推送架构**，不需要直接集成极光的原生 Android/iOS SDK！

### 📱 当前架构说明

```
前端 (React Native + Expo)
├── expo-notifications 获取 Expo Push Token
├── 将 Token 注册到后端
└── 接收推送通知

后端 (Java Spring Boot)
├── 接收前端的 Token
├── 使用极光推送 Java SDK
└── 通过极光API发送推送
```

**这种架构的优势：**

- ✅ 无需处理原生 Android/iOS 代码
- ✅ Expo 统一处理推送权限和 Token 获取
- ✅ 后端通过极光 SDK 实现推送发送
- ✅ 支持独立 APK 和真实设备推送

## 🔧 解决设备 ID 获取问题

### 问题诊断步骤

1. **检查设备类型**

   ```bash
   # 确保使用真实设备，模拟器无法获取推送Token
   ```

2. **检查推送权限**

   - 应用启动时会请求推送权限
   - 必须允许推送权限才能获取 Token

3. **检查网络连接**

   - Token 获取需要网络连接
   - 确保能访问 Expo 推送服务

4. **检查认证状态**
   - 设备注册需要用户已登录
   - 确保 JWT Token 有效

### 使用调试页面

1. 打开应用后进入 **设置 > 推送测试**
2. 查看以下信息：

   - 📱 设备信息（必须是真实设备）
   - 🔔 推送权限（必须已授权）
   - 🔑 推送 Token 状态

3. 如果 Token 未获取，点击 **🔄 重新注册设备**

### 常见问题解决

#### 问题 1: 模拟器无法获取 Token

**解决方案**: 必须使用真实设备测试

#### 问题 2: 权限被拒绝

**解决方案**:

- 卸载应用重新安装
- 或在设备设置中手动开启推送权限

#### 问题 3: 用户未登录

**解决方案**:

- 确保用户已登录
- 应用会在用户登录后自动重试注册

#### 问题 4: 网络连接问题

**解决方案**:

- 检查网络连接
- 尝试切换网络环境

## 🚀 快速验证步骤

### 1. 前端验证

```javascript
// 在推送测试页面查看日志
console.log("📱 设备类型:", Device.isDevice);
console.log("🔔 推送权限:", permissionStatus);
console.log("🔑 推送Token:", pushToken);
```

### 2. 后端验证

```bash
# 检查后端日志
grep -i "jpush\|push\|token" backend.log

# 检查极光配置
curl http://localhost:3001/api/v1/push/status
```

### 3. 测试推送发送

1. 在推送测试页面点击 **测试午餐提醒**
2. 查看后端日志确认推送发送
3. 检查手机是否收到通知

## 📋 配置检查清单

- [ ] ✅ 使用真实设备（不是模拟器）
- [ ] ✅ 推送权限已授权
- [ ] ✅ 用户已登录
- [ ] ✅ 网络连接正常
- [ ] ✅ 后端极光配置正确
- [ ] ✅ JWT Token 有效
- [ ] ✅ 应用使用独立 APK（不是 Expo Go）

## 🔍 详细日志分析

启用详细日志来排查问题：

### 前端日志关键词

```
🚀 开始初始化推送服务...
📱 检查推送权限...
🔔 请求推送权限...
🔑 获取推送Token...
✅ 推送Token获取成功
📤 向后端注册设备...
✅ 设备注册成功
```

### 后端日志关键词

```
初始化JPush客户端
JPush客户端初始化成功
用户 xxx 注册设备
设备注册成功
推送发送成功
```

## 💡 专家提示

1. **推送 Token 不等于极光 Registration ID**

   - 你的应用使用 Expo Push Token
   - 后端通过极光 SDK 转发推送

2. **推送测试最佳实践**

   - 总是使用真实设备
   - 确保应用在后台测试推送接收
   - 测试不同网络环境下的推送

3. **生产环境注意事项**
   - 确保极光环境配置为 production
   - 上传正确的 iOS 证书（如果支持 iOS）
   - 监控推送送达率和错误日志

## 🆘 如果仍然无法解决

1. 查看控制台完整日志输出
2. 检查后端 API 接口返回
3. 验证极光控制台配置
4. 确认环境变量设置正确

记住：你不需要额外的插件！当前架构已经是最佳实践。
