# ElderDiet RAG 知识库构建工作流程详解

## 🔄 整体架构图

```
原始资料 → 文档处理 → 文本预处理 → 向量化 → FAISS存储 → 语义检索
    ↓         ↓           ↓         ↓         ↓          ↓
  PDF/TXT   分割/清洗    中文分词    Embedding  向量索引    相似度计算
```

## 📊 第 2 步详细工作流程分析

### 阶段 1: 数据准备 (Data Preparation)

```
输入: src/data/nutrition_knowledge.json
↓
加载10条营养知识条目
↓
数据结构: [{"id": "1", "title": "...", "content": "...", "keywords": [...], "category": "..."}]
```

### 阶段 2: 文本预处理 (Text Processing)

```
原始文本: "糖尿病老年人应遵循以下饮食原则：1. 控制总能量摄入..."
↓
[清洗] 移除特殊字符，保留中文、英文、数字
↓
[分词] 使用jieba + 营养学专业词汇
↓
[过滤] 去除停用词，保留有意义词汇
↓
处理结果: "糖尿病 老年人 饮食 原则 控制 能量 摄入 维持 理想 体重..."
```

**TextProcessor 的关键步骤:**

1. **专业词汇增强**: 添加"糖尿病"、"膳食纤维"等营养学术语
2. **词性标注**: 只保留名词、动词、形容词等有意义词性
3. **关键词提取**: 使用 TF-IDF 算法提取关键词

### 阶段 3: 向量化 (Embedding)

```
处理后文本: "糖尿病 老年人 饮食 原则..."
↓
[模型调用] shibing624/text2vec-base-chinese
↓
[BERT编码] 768维向量 [0.1234, -0.5678, 0.9012, ...]
↓
[归一化] L2标准化，用于余弦相似度计算
↓
向量存储: numpy.array(shape=(768,), dtype=float32)
```

**Embedding 模型详情:**

- **模型**: `shibing624/text2vec-base-chinese`
- **架构**: 基于 BERT 的中文语义向量模型
- **维度**: 768 维
- **下载大小**: ~400MB（首次使用自动下载）
- **优势**: 专门针对中文优化，语义理解准确

### 阶段 4: FAISS 索引构建 (Vector Store)

```
文档向量: 10个768维向量
↓
[FAISS索引] IndexFlatIP (内积相似度)
↓
[存储结构]
├── 向量索引: faiss.IndexFlatIP
├── 文档元数据: List[Dict]
└── ID映射: doc_id → vector_index
```

**FAISS 配置:**

- **索引类型**: `IndexFlatIP` (内积相似度，精确搜索)
- **相似度计算**: 归一化向量的内积 = 余弦相似度
- **存储方式**: 内存索引 + 磁盘持久化

### 阶段 5: 检索过程 (Retrieval)

```
用户查询: "糖尿病老年人应该怎么控制饮食？"
↓
[预处理] 同样的分词和清洗流程
↓
[向量化] 转换为768维查询向量
↓
[FAISS搜索] 计算与所有文档向量的相似度
↓
[排序返回] Top-K最相似文档 + 相似度分数
```

## 🔍 检索结果分析

以查询"糖尿病老年人应该怎么控制饮食？"为例：

```
查询向量 → 相似度计算 → 排序结果

结果1: "糖尿病老年人的饮食原则" (0.7135)
├── 关键词匹配: 糖尿病✓ 老年人✓ 饮食✓
├── 语义相关: 控制饮食 ≈ 饮食原则
└── 内容吻合度: 高

结果2: "高血压老年人的饮食调理" (0.6968)
├── 关键词匹配: 老年人✓ 饮食✓
├── 语义相关: 都是慢性病营养管理
└── 内容吻合度: 中等
```

## 📈 性能指标

### 检索精度表现

- **精确匹配**: 0.7+ 相似度（如糖尿病查询 → 糖尿病文档）
- **语义相关**: 0.5-0.7 相似度（如缺钙查询 → 钙质补充文档）
- **泛化能力**: 0.3-0.5 相似度（如免疫力查询 → 营养策略文档）

### 系统性能

- **向量化速度**: ~10 文档/秒
- **检索延迟**: <100ms (10 文档规模)
- **内存占用**: ~50MB (模型) + ~1KB/文档
- **存储空间**: ~3KB/文档 (向量+元数据)

## 💡 核心技术要点

### 1. 中文文本处理

```python
# 专业词汇增强
jieba.add_word("膳食纤维", freq=1000, tag="nutrition")

# 词性过滤
meaningful_pos = {'n', 'v', 'a', 'nr', 'ns', 'nt', 'nz'}
```

### 2. 向量归一化

```python
# L2归一化，确保余弦相似度计算
vectors = vectors / np.linalg.norm(vectors, axis=1, keepdims=True)
```

### 3. FAISS 内积相似度

```python
# 归一化向量的内积 = 余弦相似度
index = faiss.IndexFlatIP(dimension)
scores, indices = index.search(query_vector, top_k)
```

## 🔄 数据流向图

```
Raw Text → TextProcessor → Embeddings → FAISS → Results
    ↓           ↓             ↓         ↓        ↓
"糖尿病..."  "糖尿病 老年人"  [0.12,...]  Index   [(doc, 0.71)]
```

## 📋 可优化方向

1. **扩大数据规模**: 10 条 → 1000+条知识
2. **多路召回**: 关键词+向量混合检索
3. **重排序**: 二阶段排序优化
4. **实时更新**: 增量索引构建
5. **多模态**: 支持图片、表格数据

---

_本文档详细解释了 ElderDiet RAG 系统第 2 步的完整工作流程，涵盖从数据准备到检索结果的每个环节。_
