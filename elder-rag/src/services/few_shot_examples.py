"""
Few-shot示例系统
提供典型的营养咨询问答示例，用于提升模型回答质量
"""

from typing import List, Dict, Any
from dataclasses import dataclass
from .prompt_template import QueryIntent


@dataclass
class FewShotExample:
    """Few-shot示例"""
    intent: QueryIntent
    user_query: str
    knowledge_context: str
    expert_response: str
    reasoning_steps: List[str]


class FewShotExampleManager:
    """Few-shot示例管理器"""
    
    def __init__(self):
        self.examples = self._load_examples()
    
    def get_examples_by_intent(self, intent: QueryIntent, max_examples: int = 2) -> List[FewShotExample]:
        """根据意图获取示例"""
        intent_examples = [ex for ex in self.examples if ex.intent == intent]
        return intent_examples[:max_examples]
    
    def format_examples_for_prompt(self, examples: List[FewShotExample]) -> str:
        """格式化示例用于prompt"""
        if not examples:
            return ""
        
        formatted_examples = []
        for i, example in enumerate(examples, 1):
            formatted_example = f"""
**示例{i}**：

**用户咨询**：{example.user_query}

**专业资料**：{example.knowledge_context}

**专家分析过程**：
{chr(10).join(f"{j+1}. {step}" for j, step in enumerate(example.reasoning_steps))}

**专家回答**：
{example.expert_response}

---
"""
            formatted_examples.append(formatted_example)
        
        return "\n".join(formatted_examples)
    
    def _load_examples(self) -> List[FewShotExample]:
        """加载预定义的示例"""
        return [
            # 疾病营养咨询示例
            FewShotExample(
                intent=QueryIntent.DISEASE_NUTRITION,
                user_query="糖尿病老人应该怎么控制饮食？",
                knowledge_context="""
【资料1】类别：疾病营养
标题：糖尿病老年人的饮食原则
内容：糖尿病老年人应遵循以下饮食原则：1. 控制总能量摄入，维持理想体重；2. 合理分配餐次，定时定量进餐；3. 限制简单糖类摄入，选择低糖指数食物；4. 增加膳食纤维摄入，每日25-30克；5. 适量优质蛋白质，每公斤体重1.0-1.2克；6. 控制饱和脂肪酸，增加不饱和脂肪酸比例。
""",
                reasoning_steps=[
                    "疾病分析：用户询问糖尿病饮食控制，糖尿病的核心问题是血糖控制，需要通过饮食管理来稳定血糖水平",
                    "营养需求评估：糖尿病患者需要控制碳水化合物摄入，增加膳食纤维，保证优质蛋白质，控制总能量",
                    "饮食原则制定：1)控制总热量摄入 2)选择低糖指数食物 3)增加膳食纤维 4)定时定量进餐",
                    "具体建议提供：推荐燕麦、糙米、绿叶蔬菜、瘦肉；限制白米、白面、甜食；建议少食多餐",
                    "注意事项说明：需要监测血糖变化，药物调整需咨询医生，出现低血糖症状及时处理"
                ],
                expert_response="""您好！针对糖尿病老年人的饮食控制，我为您提供以下专业建议：

**核心饮食原则**：
1. **控制总能量**：根据体重和活动量，一般每日1600-1800千卡
2. **选择低糖指数食物**：优选燕麦、糙米、全麦面包等
3. **增加膳食纤维**：每日25-30克，多吃绿叶蔬菜、豆类
4. **定时定量**：建议一日三餐加两次小食，规律进餐

**推荐食物**：
- 主食：燕麦片、糙米饭、全麦面条
- 蛋白质：鱼类、瘦肉、豆腐、鸡蛋
- 蔬菜：菠菜、西兰花、芹菜、黄瓜
- 水果：苹果、梨、柚子（控制量）

**需要限制**：
- 精制糖类：白糖、蜂蜜、甜品
- 精细粮食：白米、白面包
- 高脂食物：肥肉、油炸食品

**重要提醒**：
血糖控制需要饮食、运动、药物三管齐下。建议定期监测血糖，如有不适及时就医。饮食调整初期建议咨询内分泌科医生。"""
            ),
            
            # 营养素缺乏示例
            FewShotExample(
                intent=QueryIntent.NUTRIENT_DEFICIENCY,
                user_query="老年人缺钙应该怎么补充？",
                knowledge_context="""
【资料1】类别：营养素补充
标题：老年人钙质补充指南
内容：老年人钙质补充要点：1. 每日推荐摄入量1000-1200毫克；2. 优选食物来源：奶类及制品、深绿色蔬菜、豆制品、小鱼小虾；3. 促进钙吸收：适量维生素D、适度运动、避免过量咖啡因；4. 分次摄入，每次不超过500毫克；5. 避免与高纤维食物同时摄入。
""",
                reasoning_steps=[
                    "营养素识别：用户关注钙质补充，钙是构成骨骼和牙齿的重要矿物质，老年人需求量高",
                    "缺乏风险分析：老年人钙吸收率下降，缺乏可能导致骨质疏松、骨折风险增加",
                    "食物来源推荐：优先推荐奶制品、绿叶蔬菜、豆制品、小鱼小虾等天然食物来源",
                    "吸收促进建议：搭配维生素D，适量运动，避免影响吸收的因素如过量咖啡因",
                    "实用方案制定：每日牛奶250ml、豆腐100g、绿叶蔬菜200g，分次摄入"
                ],
                expert_response="""您好！老年人钙质补充确实很重要，我为您制定以下科学的补钙方案：

**为什么老年人容易缺钙**：
随着年龄增长，钙的吸收率下降，同时流失增加，容易导致骨质疏松。

**天然食物补钙方案**：
1. **奶制品**（每日250-500ml）
   - 牛奶、酸奶、奶酪
   - 每100ml牛奶含钙约100mg

2. **豆制品**（每日100-150g）
   - 豆腐、豆干、豆浆
   - 100g豆腐含钙约150mg

3. **绿叶蔬菜**（每日200-300g）
   - 菠菜、小白菜、芥蓝
   - 钙含量高且吸收率好

4. **小鱼小虾**（每周2-3次）
   - 带骨小鱼、虾皮
   - 优质钙源

**促进吸收的方法**：
- 适量晒太阳，补充维生素D
- 适度运动，促进骨骼健康
- 避免与咖啡、茶同时大量饮用

**每日推荐搭配**：
早餐：牛奶250ml + 豆浆200ml
午餐：小白菜100g + 豆腐50g  
晚餐：菠菜150g + 虾皮5g

这样可以达到每日1000-1200mg的推荐摄入量。如需钙剂补充，建议咨询医生。"""
            ),
            
            # 食物选择示例
            FewShotExample(
                intent=QueryIntent.FOOD_SELECTION,
                user_query="糖尿病老人能吃西瓜吗？",
                knowledge_context="""
【资料1】类别：食物选择
标题：糖尿病患者水果选择指导
内容：糖尿病患者可以适量食用水果，但需注意：1. 选择糖指数较低的水果；2. 控制摄入量，每次100-150克；3. 在血糖稳定时食用；4. 最好在餐后1-2小时食用；5. 西瓜含糖量中等，糖指数相对较高，需要谨慎。
""",
                reasoning_steps=[
                    "食物评估：西瓜含水分多，糖分中等，糖指数相对较高，维生素C含量丰富",
                    "适宜性分析：糖尿病患者可以吃西瓜，但需要严格控制量，因为糖指数较高",
                    "食用建议：每次100-150g，餐后1-2小时食用，避免空腹或大量食用",
                    "注意事项：血糖不稳定时暂停食用，需要监测血糖反应",
                    "替代建议：可选择苹果、梨、柚子等糖指数更低的水果"
                ],
                expert_response="""您好！糖尿病老人是可以吃西瓜的，但需要注意方法和用量：

**西瓜的营养特点**：
- 含水量高（约92%），热量相对较低
- 含糖量中等，但糖指数偏高
- 富含维生素C、番茄红素等营养素

**食用建议**：
1. **控制份量**：每次100-150克（约2-3小块）
2. **最佳时间**：餐后1-2小时食用，避免空腹
3. **食用频率**：每周2-3次，不要天天吃
4. **温度选择**：常温食用，避免冰镇

**需要注意**：
- 血糖控制不佳时暂停食用
- 食用后2小时监测血糖反应
- 如果血糖升高明显，下次要减量

**更好的选择**：
如果担心血糖影响，可以选择：
- 苹果、梨（糖指数更低）
- 柚子、橙子（纤维含量高）
- 草莓、蓝莓（抗氧化物丰富）

**总结**：西瓜可以吃，但要适量、定时、监测。在血糖稳定的前提下，偶尔享用是完全可以的！"""
            ),
            
            # 饮食规划示例
            FewShotExample(
                intent=QueryIntent.DIET_PLANNING,
                user_query="能帮我制定一个高血压老人的一日饮食计划吗？",
                knowledge_context="""
【资料1】类别：疾病食谱
标题：高血压老年人降压食谱
内容：高血压老年人降压食谱：早餐：小米粥+蒸蛋羹+凉拌芹菜；午餐：二米饭+红烧带鱼+醋溜白菜+紫菜蛋花汤；晚餐：燕麦粥+蒜蓉菠菜+清炖豆腐+银耳莲子汤。烹调特点：少盐少油，多用蒸、煮、炖方式；多用天然香料调味如姜、蒜、胡椒；增加钾含量高的食物如香蕉、土豆、西红柿。
""",
                reasoning_steps=[
                    "需求分析：高血压老人需要低盐低脂饮食，增加钾镁摄入，控制钠盐",
                    "营养目标设定：每日盐分不超过6g，增加蔬菜水果，优质蛋白质适量",
                    "食物分类规划：谷物以粗粮为主，蔬菜400g以上，适量鱼类，低脂奶制品",
                    "餐次分配：早餐30%、午餐40%、晚餐25%、加餐5%",
                    "具体食谱示例：提供一日三餐详细搭配，注重少盐少油"
                ],
                expert_response="""您好！我为高血压老人制定以下一日饮食计划：

**营养目标**：
- 每日盐分控制在5-6g以内
- 增加钾、镁、钙摄入
- 控制总热量1600-1800kcal
- 膳食纤维25-30g

**一日食谱安排**：

**早餐（7:00-8:00）**：
- 小米粥 150ml
- 蒸蛋羹 1个鸡蛋
- 凉拌芹菜 100g（少盐，用醋调味）
- 牛奶 250ml

**上午加餐（10:00）**：
- 苹果 150g 或香蕉 100g

**午餐（12:00-13:00）**：
- 二米饭（大米+小米）100g
- 清蒸带鱼 100g（少盐，用姜丝去腥）
- 醋溜白菜 150g
- 紫菜蛋花汤 200ml

**下午加餐（15:30）**：
- 无糖酸奶 150ml
- 核桃 3个

**晚餐（18:00-19:00）**：
- 燕麦粥 150ml
- 蒜蓉菠菜 150g（用蒸制，减少用油）
- 清炖豆腐 100g
- 银耳莲子汤 200ml

**烹饪要点**：
1. 用蒸、煮、炖替代炒、炸
2. 用天然香料（姜、蒜、胡椒）调味
3. 多用醋、柠檬汁提味
4. 食用油每日不超过25g

**特别提醒**：
此食谱含盐约4-5g，钾含量丰富，适合血压控制。建议配合适量运动，定期监测血压。"""
            )
        ] 